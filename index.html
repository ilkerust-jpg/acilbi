<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>acilbi</title>
<style>
body{font-family:system-ui;background:#fff;color:#111;text-align:center;padding:18px}
input,button,select,textarea{width:100%;padding:14px;margin-top:10px;font-size:16px;border-radius:8px}
button{background:#111;color:#fff;border:none}
.panel{display:none;margin-top:15px;text-align:left;background:#f3f3f3;padding:12px;border-radius:10px}
.warn{background:#ffefc2;padding:10px;border-left:4px solid #e6a700;border-radius:6px;margin-top:10px}
hr{margin:30px 0}
.emergency{background:#d32f2f;color:#fff;font-weight:bold}
</style>
</head>
<body>

<h2>acilbi</h2>

<div id="accessPanel">
  <p id="helpText">Bu kişi yardıma ihtiyaç duyabilir.</p>
  <div class="warn">Şifre: <b id="visiblePin"></b></div>
  <button id="btnAccess">Bilgileri Göster</button>
</div>

<div id="infoPanel" class="panel"></div>

<hr>

<div id="setupPanel" class="panel" style="display:none">
  <h3>Bilgi Girişi (Sahip)</h3>

  <select id="langSelect">
    <option value="tr">Türkçe</option>
    <option value="en">English</option>
  </select>

  <input id="nameInput" placeholder="Ad Soyad">

  <select id="bloodInput">
    <option value="">Kan Grubu Seçin</option>
    <option>A Rh+</option>
    <option>A Rh-</option>
    <option>B Rh+</option>
    <option>B Rh-</option>
    <option>AB Rh+</option>
    <option>AB Rh-</option>
    <option>0 Rh+</option>
    <option>0 Rh-</option>
  </select>

  <textarea id="conditionInput" placeholder="Kronik Rahatsızlıklar"></textarea>
  <textarea id="medInput" placeholder="Rutin Kullanılan İlaçlar"></textarea>
  <textarea id="allergyInput" placeholder="Alerjiler"></textarea>
  <input id="telInput" placeholder="Acil Kişi Telefon">

  <button onclick="saveData()">Kaydet</button>
</div>

<script>
const API = "https://acilbi-api.ilkerust.workers.dev";
const params = new URLSearchParams(location.search);
const id = params.get("id");

document.getElementById("visiblePin").innerText = id || "";

if(location.search.includes("setup=1")){
  document.getElementById("setupPanel").style.display="block";
}

const texts = {
  tr: {
    help: "Bu kişi yardıma ihtiyaç duyabilir.",
    show: "Bilgileri Göster",
    emergency: "Acil Kişi",
    blood: "Kan Grubu",
    cond: "Kronik Rahatsızlıklar",
    meds: "Rutin İlaçlar",
    allergy: "Alerjiler",
    call: "Acil Kişiyi Ara",
    call112: "112'yi Ara",
    saved: "Kaydedildi!"
  },
  en: {
    help: "This person may need help.",
    show: "Show Information",
    emergency: "Emergency Contact",
    blood: "Blood Type",
    cond: "Chronic Conditions",
    meds: "Medications",
    allergy: "Allergies",
    call: "Call Emergency Contact",
    call112: "Call 112",
    saved: "Saved!"
  }
};

document.getElementById("btnAccess").onclick = async ()=>{
  const res = await fetch(`${API}?id=${id}`);
  const data = await res.json();

  if(!data.name){
    alert("Bilgi bulunamadı");
    return;
  }

  const lang = data.lang || "tr";
  const t = texts[lang];

  document.getElementById("helpText").innerText = t.help;
  document.getElementById("btnAccess").innerText = t.show;

  const panel = document.getElementById("infoPanel");
  panel.style.display="block";
  panel.innerHTML = `
    <h3>${data.name}</h3>
    <p><b>${t.blood}:</b> ${data.blood || "-"}</p>
    <p><b>${t.cond}:</b> ${data.conditions || "-"}</p>
    <p><b>${t.meds}:</b> ${data.meds || "-"}</p>
    <p><b>${t.allergy}:</b> ${data.allergies || "-"}</p>
    <p><b>${t.emergency}:</b> ${data.emTel}</p>

    <button onclick="location.href='tel:${data.emTel}'">${t.call}</button>
    <button class="emergency" onclick="location.href='tel:112'">${t.call112}</button>
  `;
};

async function saveData(){
  const body = {
    name: document.getElementById("nameInput").value,
    blood: document.getElementById("bloodInput").value,
    conditions: document.getElementById("conditionInput").value,
    meds: document.getElementById("medInput").value,
    allergies: document.getElementById("allergyInput").value,
    emTel: document.getElementById("telInput").value,
    lang: document.getElementById("langSelect").value
  };

  await fetch(`${API}?id=${id}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(body)
  });

  alert(texts[body.lang].saved);
}
</script>

</body>
</html>
